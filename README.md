# ClawNest

A full-stack React + Express web application for managing AI agents with real AI functionality, Telegram integration, and Stripe payments.

## Architecture

- **Frontend**: React 19 + TypeScript + TailwindCSS v4 + React Router v7
- **Backend**: Express.js served via the same Node.js process
- **Database**: SQLite via `better-sqlite3` (file: `clawnest.db`) for users/agents
- **PostgreSQL**: Replit PostgreSQL for Stripe data sync (stripe-replit-sync)
- **Bundler**: Vite 6 (build tool only — frontend is pre-built to `dist/`)
- **Auth**: JWT stored in HTTP-only cookies
- **AI Runtime**: OpenAI via Replit AI Integrations (server-side, no user API keys needed)
- **Telegram**: `node-telegram-bot-api` for Telegram bot integration per agent
- **Payments**: Stripe via Replit Stripe integration + stripe-replit-sync
- **Logo/Favicon**: Crab mascot image at `public/favicon.png`

## Project Structure

```
server.ts              - Express server entry point (serves API + static frontend)
server/
  agentRuntime.ts      - Server-side AI agent runtime using OpenAI
  telegramManager.ts   - Telegram bot lifecycle manager
  stripeClient.ts      - Stripe client with Replit connector credentials
  webhookHandlers.ts   - Stripe webhook handler (delegates to stripe-replit-sync)
  seedProducts.ts      - Script to create ClawNest Pro product in Stripe
dist/                  - Built frontend assets (generated by `vite build`)
public/
  favicon.png          - App logo/favicon (crab mascot)
src/
  main.tsx             - React app entry
  App.tsx              - Root component with routing
  pages/               - Page components (Landing, Dashboard, Login, SignUp, Blog)
  components/          - Shared UI components (Navbar, ChatWidget, AgentConnectModal)
  context/             - React context (AuthContext)
  layouts/             - Layout components (DocsLayout)
  index.css            - Global styles
index.html             - HTML entry point
vite.config.ts         - Vite build configuration
```

## Running

```bash
npm run dev   # Builds frontend then starts Express server on port 5000
npm run build # Builds frontend to dist/
```

## Environment Variables

- `AI_INTEGRATIONS_OPENAI_API_KEY` - OpenAI API key (set by Replit AI Integrations)
- `AI_INTEGRATIONS_OPENAI_BASE_URL` - OpenAI base URL (set by Replit AI Integrations)
- `JWT_SECRET` - JWT signing secret (defaults to dev key in development)
- `PORT` - Server port (defaults to 5000)
- `DATABASE_URL` - PostgreSQL connection string (for Stripe data sync)

## Key Features

- **Real AI Agents**: Server-side agent runtime powered by OpenAI (gpt-4o-mini)
- **Custom System Prompts**: Users can define agent personality and behavior
- **Telegram Integration**: Agents auto-connect to Telegram when a bot token is provided
- **Support Chat**: "Nestor" support bot uses server-side AI (no client-side API keys)
- **No API Keys Required**: Users don't need to provide their own API keys
- **Freemium Model**: Starter (1 agent free) / Pro (10 agents, €24/month via Stripe)
- **Stripe Payments**: Checkout sessions for upgrades, customer portal for subscription management

## Stripe Integration

- Stripe credentials fetched via Replit connector API (no hardcoded keys)
- `stripe-replit-sync` manages the `stripe` schema in PostgreSQL automatically
- Webhook route registered BEFORE `express.json()` middleware
- Products created via `npx tsx server/seedProducts.ts` (ClawNest Pro at €24/month)
- Plan activation via `checkout.session.completed` webhook event
- Plan downgrade via `customer.subscription.deleted` webhook event
- Users table has `stripe_customer_id` column for linking to Stripe customers

## Key Notes

- Server listens on `0.0.0.0:5000`
- Frontend is pre-built to `dist/` and served statically by Express
- No Vite dev server in runtime (avoids instability from file watchers in Replit)
- To see frontend changes, run `npm run build` and restart the workflow
- Cookies use `SameSite=None; Secure` for cross-origin iframe compatibility
- Database tables: `users` (with stripe_customer_id), `agents` (with system_prompt)
- Workflow command: `npx tsx server.ts` (not `node --import tsx/esm`)
- Telegram bots auto-restore on server startup for running agents
